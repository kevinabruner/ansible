- name: "Rebuild and Configure: {{ inventory_hostname }}"
  when: 
    - "'repo_' + current_app in group_names"
  block:
    - name: "Infrastructure: Force Rebuild for {{ inventory_hostname }}"
      delegate_to: terraform
      shell: |
        terraform apply \
          -replace='proxmox_vm_qemu.proxmox_vms["{{ inventory_hostname }}"]' \
          -auto-approve
      args:
        chdir: "/home/kevin/terraform"

    - name: "Stability: Wait for {{ inventory_hostname }} SSH"
      delegate_to: localhost
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: started
        delay: 20
        timeout: 300        

    - name: "Cron: Create staggered rsync backup"
      become: true
      ansible.builtin.cron:
        name: "Backup CephFS to NFS"        
        hour: "{{ (3 + groups['repo_' + current_app].index(inventory_hostname)) % 24 }}"
        minute: "0"
        job: "rsync -az --delete {{ ceph_target_dir }}/ {{ nfs_target_dir }}/"
        user: root

