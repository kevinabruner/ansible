- name: Bake Drupal Images
  hosts: localhost
  gather_facts: false
  remote_user: root
  vars_files:
    - vars.yaml
    - vault.yaml

  tasks:
    - name: Identify Apps and Nodes
      set_fact:
        app_list: >-
          {% set apps = [] %}
          {% for host in groups['role_drupal'] %}
            {% set repo = hostvars[host].group_names | select('match', '^repo_') | first | replace('repo_', '') %}
            {% if ansible_limit is not defined or repo in ansible_limit %}
              {% if repo not in apps %}
                {% set _ = apps.append(repo) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ apps }}
        proxmox_nodes: "{{ groups['role_proxmox_host'] | difference(groups['legs'] | default([])) }}"

    - name: Trigger Baking Process
      include_tasks: tasks/3-bake-image-tasks.yaml
      loop: "{{ app_list }}"
      loop_control:
        loop_var: current_app
      run_once: true