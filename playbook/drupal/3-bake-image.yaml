- name: Create Production Templates
  # This targets the Proxmox hosts regardless of your --limit
  hosts: role_proxmox_host:!legs
  gather_facts: false
  remote_user: root  
  vars_files:
    - vars.yaml
    - vault.yaml
  tasks:
    - name: Get list of applications from the --limit flag
      run_once: true
      set_fact:
        # We look at ALL hosts in role_drupal, but only those matching the current limit
        # 'ansible_limit_hosts' contains the hosts passed via --limit
        app_list: "{{ groups['role_drupal'] | intersect(ansible_limit_hosts | default(groups['role_drupal'])) | map('extract', hostvars, 'group_names') | flatten | select('match', '^repo_') | map('replace', 'repo_', '') | unique | list }}"

    - name: "DEBUG - Apps to be baked"
      run_once: true
      ansible.builtin.debug:
        msg: "Limit detected. Baking templates for: {{ app_list }}"

    - name: Process each application template
      # We still want the Proxmox hosts to loop through the apps
      include_tasks: tasks/3-bake-image-tasks.yaml
      loop: "{{ app_list }}"
      loop_control:
        loop_var: current_app
      when: app_list | length > 0