---
- name: "PREP: Identify IDs for {{ current_app }} on {{ current_node }}"
  set_fact:
    source_vmid: "{{ hostvars[groups['repo_' + current_app][0]]['custom_fields']['vmid'] }}"
    template_vmid: "{{ hostvars[groups['repo_' + current_app][0]]['custom_fields']['vmid'] ~ '0' }}"

- name: "GLOBAL CLEANUP: Ensure {{ template_vmid }} is gone from PVE"
  # We delegate this specifically to PVE because that is where templates live
  delegate_to: pve
  block:
    - name: "Check if {{ template_vmid }} exists on PVE"
      shell: "qm status {{ template_vmid }}"
      register: pve_template_check
      failed_when: false
      changed_when: false

    - name: "Destroy existing template on PVE"
      shell: |
        qm unlock {{ template_vmid }} || true
        qm destroy {{ template_vmid }} --purge
      when: pve_template_check.rc == 0

- name: "LOCAL CLEANUP: Ensure {{ template_vmid }} is gone from {{ current_node }}"
  # Now we check the current node in the loop to prevent the "File exists" error
  delegate_to: "{{ current_node }}"
  when: current_node != 'pve'
  block:
    - name: "Check if {{ template_vmid }} exists on {{ current_node }}"
      shell: "qm status {{ template_vmid }}"
      register: local_template_check
      failed_when: false
      changed_when: false

    - name: "Destroy existing VM on {{ current_node }}"
      shell: "qm destroy {{ template_vmid }} --purge"
      when: local_template_check.rc == 0

- name: "SOURCE: Clone and Move {{ current_app }}"
  delegate_to: "{{ current_node }}"
  block:
    - name: "Locate source VM {{ source_vmid }} on {{ current_node }}"
      shell: "qm config {{ source_vmid }}"
      register: source_vm_check
      failed_when: false
      changed_when: false

    - name: "Clone and Migrate"
      when: source_vm_check.rc == 0
      shell: |
        qm clone {{ source_vmid }} {{ template_vmid }} --full --name {{ current_app }}-golden --storage truenas-nfs
        {% if current_node != 'pve' %}
        qm migrate {{ template_vmid }} pve
        {% endif %}