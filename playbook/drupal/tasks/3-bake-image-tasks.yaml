- name: "PREP: Identify IDs and reset state for {{ current_app }}"
  set_fact:
    # We grab the VMID from the first host in the specific repo group
    source_vmid: "{{ hostvars[groups['repo_' + current_app][0]]['custom_fields']['vmid'] }}"
    template_vmid: "{{ hostvars[groups['repo_' + current_app][0]]['custom_fields']['vmid'] ~ '0' }}"
    bake_complete: false

- name: "GLOBAL CLEANUP: Ensure {{ template_vmid }} is gone from PVE"
  delegate_to: pve
  vars:
    ansible_user: root
  shell: |
    qm unlock {{ template_vmid }} || true
    qm destroy {{ template_vmid }} --purge || true
  failed_when: false

- name: "SEARCH & BAKE: Find VM across nodes"
  include_tasks: 3-bake-search-logic.yaml
  loop: "{{ proxmox_nodes }}"
  loop_control:
    loop_var: node_item
  # Only continue searching if we haven't successfully cloned/migrated yet
  when: 
    - node_item != 'legs'
    - not bake_complete

- name: "SANITIZE: Finalize Template on PVE"
  delegate_to: pve
  vars:
    ansible_user: root
  block:
    - name: "Wait for Migration to finish"
      shell: "qm status {{ template_vmid }}"
      register: pve_vm_check
      until: pve_vm_check.rc == 0
      retries: 30
      delay: 5

    - name: "Start {{ current_app }} for sanitization"
      shell: "qm set {{ template_vmid }} --agent 1 && qm start {{ template_vmid }}"

    - name: "Wait for Guest Agent on {{ current_app }}"
      shell: "qm guest exec {{ template_vmid }} -- /bin/sh -c uptime"
      register: agent_ready
      until: agent_ready.rc == 0
      retries: 20
      delay: 10

    - name: "Run Sanitization Scripts"
      shell: "qm guest exec {{ template_vmid }} -- /bin/sh -c '{{ item }}'"
      loop:
        - "cloud-init clean --logs"
        - "truncate -s 0 /etc/machine-id"
        - "rm -f /etc/ssh/ssh_host_*"

    - name: "Finalize: Stop and Template"
      shell: |
        qm shutdown {{ template_vmid }}
        while [ "$(qm status {{ template_vmid }})" != "status: stopped" ]; do 
          sleep 5
        done
        qm template {{ template_vmid }}
      when: bake_complete