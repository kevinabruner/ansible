- name: Deploy Prod Apps from Golden Images
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars.yaml
    - vault.yaml
  tasks:
    - name: Identify Apps to Deploy
      set_fact:
        # If 'app' is passed, use it. Otherwise, target all Production Drupal apps.
        drupal_apps: >-
          {% if drupal_app is defined %}
            {{ [drupal_app] }}
          {% else %}
            {{ groups['role_drupal'] | intersect(groups['env_prod']) | map('extract', hostvars, 'group_names') | flatten | select('match', '^repo_') | map('replace', 'repo_', '') | unique | list }}
          {% endif %}

    - name: "DEBUG - Deployment Scope"
      ansible.builtin.debug:
        msg: "The following apps will be deployed: {{ drupal_apps }}"

    - name: Process Serial Deployment
      include_tasks: tasks/4-deploy-prod-tasks.yaml
      loop: "{{ drupal_apps }}"
      loop_control:
        loop_var: current_app
      when: drupal_apps | length > 0