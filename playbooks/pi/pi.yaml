- name: Build 
  hosts: pi
  tasks:
    - name: Ping my hosts
      ansible.builtin.ping:

    - name: Check if SSH key is already present
      stat:
        path: "/home/kevin/.ssh/id_rsa.pub"
      register: key_stat_result

    - name: Generate SSH key for accessing GitHub
      command: "ssh-keygen -t rsa -f  -N ''"
      when: not key_stat_result.stat.exists

    - name: Get key content
      command: "cat /home/kevin/.ssh/id_rsa.pub"
      register: key_content

    - name: Check if known_host exists
      stat:
        path: "/home/kevin/.ssh/known_hosts"
      register: known_hosts_stat

    - name: Create known_hosts if it doesn't exist
      file:
        path: "/home/kevin/.ssh/known_hosts"
        state: touch
      when: not known_hosts_stat.stat.exists

    - name: Get the content of known hosts
      shell: "cat /home/kevin/.ssh/known_hosts | grep github.com"
      register: host_stat
      failed_when: host_stat.rc > 1

    - name: Add SSH public key to GitHub account
      uri:
        url: https://api.github.com/user/keys
        validate_certs: no
        method: POST
        body:
          title: "pi"
          key: "{{ lookup('file', '/home/kevin/.ssh/id_rsa.pub') }}"
        body_format: json
        headers:
          Content-Type: "application/json"
          Authorization: "token !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38396130613661653436626662613839363064346566316265383132346432626530323239346330
          6531393132393538613866643536646564633436393633380a363437613033393535346435663233
          34353035646436383230616665663735376139613237316531353163353361663730666666663635
          6231353730656361610a396666633565623436386136373135353438623831376162383430333939
          31643437643639303739366432393434376635326231356138363437653462306165393537326136
          3030386331343635633565633162383464356639373966373065"
      register: task_log
      failed_when: "'key is already in use' in task_log.stderr"


    - name: Clone the repository
      shell: GIT_SSH_COMMAND="ssh -i  -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"  clone  