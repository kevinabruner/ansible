plugin: netbox.netbox.nb_inventory
api_endpoint: https://netbox.thejfk.ca
validate_certs: True
token: "{{ lookup('env', 'NETBOX_API_TOKEN') }}"
config_context: True  # Changed to True to see if DNS names are stored there
fetch_all: True
compose:
  # This creates a flat list of all IPs on the host for easy looping
  all_ips: interfaces | map(attribute='ip_addresses') | flatten
group_by:
  - device_roles
use_cache: yes

# This ensures that even if a host isn't 'active', 
# we still see its data if we need it for DNS
device_query_filters:
  - status: 'active'
vm_query_filters:
  - status: 'active'

keyed_groups:
  - prefix: repo
    key: custom_fields.repos
  - prefix: env
    key: custom_fields.dev_or_prod
  - prefix: role
    key: device_roles